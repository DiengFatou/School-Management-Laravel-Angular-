<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <button class="btn btn-light btn-sm me-3" (click)="retourTableauDeBord()">
          <i class="fas fa-arrow-left me-1"></i> Retour
        </button>
        <h2 class="mb-0">Gestion des Bulletins</h2>
      </div>
      <button class="btn btn-light btn-sm" (click)="exportToExcel()" [disabled]="filteredBulletins.length === 0">
        <i class="fas fa-file-excel me-1"></i> Exporter en Excel
      </button>
    </div>
    <div class="card-body">
      <!-- Onglets -->
      <ul class="nav nav-tabs mb-4" id="bulletinTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current" type="button" role="tab" aria-controls="current" aria-selected="true">
            Bulletin actuel
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false" (click)="loadHistory()">
            Historique
          </button>
        </li>
      </ul>
      
      <!-- Contenu des onglets -->
      <div class="tab-content" id="bulletinTabsContent">
        <!-- Onglet Bulletin Actuel -->
        <div class="tab-pane fade show active" id="current" role="tabpanel" aria-labelledby="current-tab">
      <!-- Filtres et actions -->
      <div class="row mb-4 g-3">
        <div class="col-12 mb-3">
          <button class="btn btn-success" (click)="genererBulletins()" [disabled]="!selectedAnnee || !selectedClasse || loading">
            <i class="fas fa-file-pdf me-2"></i>Générer les bulletins
            <span *ngIf="loading" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
          </button>
          <div *ngIf="generationMessage" class="alert alert-info mt-2">
            {{ generationMessage }}
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Année Scolaire</label>
          <select class="form-select" [(ngModel)]="selectedAnnee" (change)="filterBulletins()" [disabled]="loading">
            <option *ngFor="let annee of anneesScolaires" [value]="annee.id">{{ annee.nom }}</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Trimestre</label>
          <select class="form-select" [(ngModel)]="selectedTrimestre" (change)="filterBulletins()" [disabled]="loading">
            <option value="1">1er Trimestre</option>
            <option value="2">2ème Trimestre</option>
            <option value="3">3ème Trimestre</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Classe</label>
          <select class="form-select" [(ngModel)]="selectedClasse" (change)="filterBulletins()" [disabled]="loading">
            <option *ngFor="let classe of classes" [value]="classe.id">{{ classe.nom }}</option>
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end gap-2">
          <button class="btn btn-success flex-grow-1" (click)="genererBulletins()" [disabled]="!selectedAnnee || !selectedClasse || loading">
            <span *ngIf="!loading">
              <i class="fas fa-file-pdf me-2"></i>Générer les bulletins
            </span>
            <span *ngIf="loading">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Génération en cours...
            </span>
          </button>
          <button class="btn btn-primary" (click)="telechargerTous()" [disabled]="filteredBulletins.length === 0 || loading" title="Télécharger tous les bulletins">
            <i class="fas fa-download"></i>
          </button>
        </div>
      </div>
      
      <!-- Message d'information -->
      <div class="alert alert-info" *ngIf="!selectedAnnee || !selectedClasse">
        <i class="fas fa-info-circle me-2"></i>
        Veuillez sélectionner une année scolaire et une classe pour afficher les bulletins.
      </div>
      
      <div class="alert alert-warning" *ngIf="selectedAnnee && selectedClasse && filteredBulletins.length === 0">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Aucun bulletin trouvé pour les critères sélectionnés.
      </div>

      <!-- Tableau des bulletins -->
      <div class="table-responsive" *ngIf="filteredBulletins.length > 0">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            {{ filteredBulletins.length }} bulletin(s) trouvé(s)
          </div>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="exportToExcel()" [disabled]="filteredBulletins.length === 0">
              <i class="fas fa-file-excel me-1"></i> Exporter en Excel
            </button>
            <button class="btn btn-sm btn-outline-primary" (click)="telechargerTous()" [disabled]="filteredBulletins.length === 0 || loading">
              <i class="fas fa-file-archive me-1"></i> Télécharger tout (ZIP)
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Élève</th>
                <th>Classe</th>
                <th>Trimestre</th>
                <th>Moyenne</th>
                <th>Rang</th>
                <th>Mention</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let bulletin of filteredBulletins; let i = index">
                <td class="text-muted">{{ i + 1 }}</td>
                <td>{{ bulletin.eleve_nom }}</td>
                <td>{{ bulletin.classe_nom }}</td>
                <td>{{ bulletin.trimestre }}<sup>ème</sup> Trimestre</td>
                <td>
                  <span class="fw-bold">{{ bulletin.moyenne_generale | number:'1.2-2' }}</span>
                  <small class="text-muted d-block">/20</small>
                </td>
                <td>
                  <span class="badge bg-secondary">{{ bulletin.rang }}<span *ngIf="bulletin.rang === 1">er</span><span *ngIf="bulletin.rang > 1">e</span></span>
                </td>
                <td>
                  <span class="badge" [ngClass]="getMentionClass(bulletin.mention)">
                    {{ bulletin.mention }}
                  </span>
                </td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" (click)="voirBulletin(bulletin.id)" title="Voir le bulletin">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" (click)="telechargerBulletin(bulletin.id)" title="Télécharger le PDF">
                      <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline-warning" (click)="envoyerEmail(bulletin)" title="Envoyer par email">
                      <i class="fas fa-envelope"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Boutons d'action en bas -->
      <div class="mt-3 d-flex justify-content-between">
        <div>
          <button class="btn btn-outline-primary me-2" (click)="telechargerTous()">
            <i class="fas fa-download me-2"></i>Télécharger tous
          </button>
          <button class="btn btn-outline-success" (click)="envoyerTousEmails()" [disabled]="filteredBulletins.length === 0">
            <i class="fas fa-paper-plane me-2"></i>Notifier tous les parents
          </button>
        </div>
        <button class="btn btn-primary" (click)="openAddModal()">
          <i class="fas fa-plus me-2"></i>Ajouter un bulletin
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de visualisation du bulletin -->
<div class="modal fade" id="bulletinModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bulletin de {{ selectedBulletin?.eleve_nom }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Contenu du bulletin -->
        <div *ngIf="selectedBulletin" class="bulletin-preview">
          <div class="text-center mb-4">
            <h4>Établissement Scolaire</h4>
            <h5>Bulletin de notes - {{ selectedBulletin.trimestre }}ème Trimestre {{ selectedBulletin.annee_scolaire }}</h5>
          </div>
          
          <div class="row mb-4">
            <div class="col-md-6">
              <p><strong>Nom:</strong> {{ selectedBulletin.eleve_nom }}</p>
              <p><strong>Classe:</strong> {{ selectedBulletin.classe_nom }}</p>
            </div>
            <div class="col-md-6 text-end">
              <p><strong>Moyenne Générale:</strong> {{ selectedBulletin.moyenne_generale | number:'1.2-2' }}/20</p>
              <p><strong>Rang:</strong> {{ selectedBulletin.rang }} sur {{ totalElevesClasse }}</p>
            </div>
          </div>

          <!-- Détails des matières -->
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Matière</th>
                  <th>Note</th>
                  <th>Appréciation</th>
                  <th>Coefficient</th>
                  <th>Moyenne Classe</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let note of selectedBulletin.notes">
                  <td>{{ note.matiere_nom }}</td>
                  <td>{{ note.valeur }}/20</td>
                  <td>{{ note.appreciation || '-' }}</td>
                  <td>{{ note.coefficient }}</td>
                  <td>{{ note.moyenne_classe | number:'1.2-2' }}/20</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Appréciation générale -->
          <div class="mt-4 p-3 bg-light">
            <h6>Appréciation générale:</h6>
            <p>{{ selectedBulletin.appreciation || 'Aucune appréciation disponible.' }}</p>
            <div class="text-end">
              <p class="mb-0">Le {{ selectedBulletin.date_generation | date:'dd/MM/yyyy' }}</p>
              <p class="mb-0">Le Chef d'Établissement</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-primary" (click)="imprimerBulletin()">
          <i class="fas fa-print me-2"></i>Imprimer
        </button>
      </div>
    </div>
  </div>
</div>
